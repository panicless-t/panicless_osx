//
//  k_utility.c
//  panicless_osx
//
//  Created by ali on 2.03.2021.
//

#include "k_utility.h"

#define msleep(time)\
sleep(time);

uint32_t k_write32(mach_port_t fake_task,vm_offset_t offset,uint32_t val){

    vm_offset_t kern_txt_orig;
    mach_vm_read(fake_task, offset, 4, kern_txt_orig, 0);
    printf("[+] (read/kern) orig where:0x%d -> val %d\n",offset,kern_txt_orig);
    mach_vm_protect(fake_task, offset, sizeof(val), sizeof(val), VM_PROT_ALL);
    mach_vm_write(fake_task, offset, val, sizeof(val));
    vm_offset_t kern_txt;
    mach_vm_read(fake_task, offset, 4, &kern_txt, 0);
    printf("[+] (read/kern) patched where:0x%d -> val %d\n",offset,&kern_txt);
    return kern_txt;
}

uint64_t k_write64(mach_port_t fake_task,vm_offset_t offset,uint64_t val){

    vm_offset_t kern_txt_orig;
    mach_vm_read(fake_task, offset, 8, &kern_txt_orig,0);
    printf("[+] (read/kern) orig where:0x%lu -> val %d\n",offset,&kern_txt_orig);
    mach_vm_protect(fake_task, offset, sizeof(val), sizeof(val), VM_PROT_ALL);
    mach_vm_write(fake_task, offset, val, sizeof(val));
    vm_offset_t kern_txt;
    mach_vm_read(fake_task, offset, 8, &kern_txt, 0);
    printf("[+] (read/kern) patched where:0x%d -> val %d\n",offset,&kern_txt);
    return 0;
}

uint32_t k_read32(mach_port_t fake_task,vm_offset_t off,size_t size){
 
    uint64_t kern_txt;
    mach_vm_protect(fake_task, off, size, 10, VM_PROT_READ);
    mach_vm_read(fake_task, off, size, &kern_txt, 0);
    printf("[+] (read/kern) READ/MEMORY LEAK \nwhere 0x%lu ->\ninfo: nil\n",off);
    return kern_txt;
}
